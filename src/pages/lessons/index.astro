---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import LessonCard from '../../components/LessonCard.astro';

const allLessons = await getCollection('lessons');

// Group lessons by Phase -> Module
const grouped = allLessons.reduce((acc, lesson) => {
  const phase = lesson.data.phase;
  const module = lesson.data.module;

  if (!acc[phase]) acc[phase] = {};
  if (!acc[phase][module]) acc[phase][module] = [];

  acc[phase][module].push(lesson);
  return acc;
}, {} as Record<string, Record<string, typeof allLessons>>);

// Sort phases and modules if needed (using default alphabetical or specific logic)
const phases = Object.keys(grouped).sort(); // "Phase I" comes before "Phase II" naturally
---
<BaseLayout title="Lessons · Mara Language" description="Browse Mara lessons by level and order.">
  <header class="mb-10">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Curriculum</p>
        <h1 class="text-3xl font-bold text-white mt-2">Lesson Index</h1>
      </div>
      <a href="/curriculum" class="text-sm font-semibold text-brand-primary hover:text-white transition">
        View Full Roadmap →
      </a>
    </div>
    <p class="text-slate-300 mt-3 max-w-3xl">
      Follow the phases to master the language found in our <a href="/curriculum" class="underline decoration-slate-600 hover:decoration-brand-primary">comprehensive curriculum</a>.
    </p>
  </header>

  <div class="space-y-12">
    {phases.map((phase) => (
      <section>
        <h2 class="text-2xl font-bold text-white mb-6 border-b border-slate-800 pb-2">{phase}</h2>
        <div class="space-y-8">
          {Object.keys(grouped[phase]).sort().map((module) => (
            <div class="bg-slate-900/30 rounded-2xl p-6 border border-slate-800/50 glass-panel">
              <h3 class="text-xl font-semibold text-brand-light mb-4 flex items-center gap-3">
                <span class="bg-brand-primary/20 text-brand-primary text-xs px-2 py-1 rounded uppercase tracking-wider">Module</span>
                {module.replace(/^Module \d+: /, '')}
              </h3>

              <div class="grid gap-4 md:grid-cols-2">
                {grouped[phase][module]
                  .sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0))
                  .map(({ slug, data }) => (
                    <LessonCard slug={slug} data={data} />
                  ))}
              </div>
            </div>
          ))}
        </div>
      </section>
    ))}
  </div>
</BaseLayout>
